name: Build & Release Docker Image

on:
  push:
    tags: ['v*']          # 只在打 tag (如 v1.0.0) 时构建
  workflow_dispatch:       # 也支持手动触发

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: cintia09/openclaw-pro

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # 需要 write 权限上传 Release
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 构建镜像
      - name: Build Docker image
        run: docker build --build-arg BUILD_VERSION=${{ github.ref_name }} -t openclaw-pro:latest .

      # 推送到 GHCR (可选，给有条件访问的用户)
      - name: Tag and push to GHCR
        run: |
          docker tag openclaw-pro:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker tag openclaw-pro:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

      # 导出镜像为 tar.gz (用户直接下载，无需 Docker Hub/GHCR)
      - name: Export image as tar.gz
        run: |
          docker save openclaw-pro:latest | gzip > openclaw-pro-image.tar.gz
          ls -lh openclaw-pro-image.tar.gz
          sha256sum openclaw-pro-image.tar.gz > openclaw-pro-image.tar.gz.sha256

      # 上传到 GitHub Release
      - name: Create Release and upload image
        uses: softprops/action-gh-release@v2
        with:
          name: OpenClaw Pro ${{ github.ref_name }}
          body: |
            ## OpenClaw Pro Docker 镜像

            ### 一键安装 (Windows)
            ```powershell
            irm https://raw.githubusercontent.com/cintia09/openclaw-pro/main/install-windows.ps1 | iex
            ```

            ### 一键安装 (Linux/macOS)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/cintia09/openclaw-pro/main/install.sh | bash
            ```

            ### 手动安装
            1. 下载 `openclaw-pro-image.tar.gz`
            2. `docker load < openclaw-pro-image.tar.gz`
            3. HTTP 直连模式：
               `docker run -d --name openclaw-pro -p 18789:18789 -p 3000:3000 -v ./home-data:/root --restart unless-stopped openclaw-pro:latest`

            4. HTTPS 反代模式（推荐，需域名解析到本机）：
               - 创建 `./home-data/.openclaw/docker-config.json`：
                 `{"domain":"your.domain.com","http_port":80,"https_port":443,"browserEnabled":false}`
               - 运行容器：
                 `docker run -d --name openclaw-pro -p 80:80 -p 443:443 -v ./home-data:/root --restart unless-stopped openclaw-pro:latest`

            5. 浏览器功能默认关闭，可在 Web 面板「系统设置」里开启（保存后重启容器生效）。
          files: |
            openclaw-pro-image.tar.gz
            openclaw-pro-image.tar.gz.sha256
